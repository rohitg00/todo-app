import { expose } from '@teambit/worker';
import { UserConfig as ViteConfig } from 'vite';
import { startVitest } from 'vitest/node';

import WatchReporter from './watch-reporter.js';

export class VitestWorker {
  private onTestCompleteCb: ((files: any, errors: any) => void) | undefined;

  onTestComplete(onTestComplete: ((files: any, errors: any) => void) | undefined) {
    this.onTestCompleteCb = onTestComplete;
  }

  async watch(viteConfig: ViteConfig): Promise<void> {
    // eslint-disable-next-line no-param-reassign
    viteConfig.test!.reporters = [
      new WatchReporter(
        async (files, errors) => {
          if (this.onTestCompleteCb) {
            this.onTestCompleteCb(files, errors)
          }
        }
      ) as any
    ];
    await startVitest('test', undefined, undefined, viteConfig);
  }
}

expose(new VitestWorker());
